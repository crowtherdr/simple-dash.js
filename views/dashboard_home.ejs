<%
  var SLOW_RESPONSE = 5000
    , FAST_RESPONSE = 300
    , DOWN_THRESHOLD = 50
    , WARN_MEMORY = 400;
%>

<!DOCTYPE html>
<html>
<head>
  <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="/vendor/bootstrap/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="/css/dashboard.css">
</head>


<!-- 
  TODO:
  1) Make the Uptime history as part of the header part...


 -->

<body class="home">
  <p class="last_updated">Last updated at ...</p>
  
  <div class="mast_head section">
    <h1 class="page_title">FamilySearch Status </h1> 
  
    
    

    <!-- <p>Home page</p> -->

  </div>
  
  <div class="legend">
    <span class="item status-good"><span class="glyphicon glyphicon-ok-sign" style="top: 2px;"></span> Good </span>
    <span class="item status-warning"><span class="glyphicon glyphicon-warning-sign" style="top: 2px;"></span> Slow </span>
    <span class="item status-down"><span class="glyphicon glyphicon-minus-sign" style="top: 2px;"></span> Down</span> 
    <span class="item status-unknown"><span class="glyphicon glyphicon-question-sign" style="top: 2px;"></span> Unkown </span>
  </div>

  <table class="status-table">
    <th colspan="3">Upstream</th>
    <tr>
      <td class="status-good"><span class="glyphicon glyphicon-ok-sign" style="top: 2px;"></span> HA Proxy</td>
      <td class="status-warning"><span class="glyphicon glyphicon-ok-sign" style="top: 2px;"></span> Heroku</td>
      <td class="status-down"><span class="glyphicon glyphicon-ok-sign" style="top: 2px;"></span> Something</td>
    </tr>
  </table>

  <table class="status-table">
    <th colspan="3">Frontier</th>
    <!-- TODO: CLEAN UP THIS CODE & THESE RULES. SHOULD THESE EVEN BE HANDLED HERE? A: NO -->
 <%
      var i=0, l, _rel
      for (appName in appData) {
        _rel = appData[appName];
        avgMemory = _rel.memory && parseInt(_rel.memory.avg) || 0;
        responseCode = _rel.responseCode || {};
        error_rate = (responseCode['5xx'] && responseCode.total ? Math.round((responseCode['5xx']/responseCode.total) * 10000)/100 : 0);
        responseTime = _rel.responseTime || {};

        status = "";

        switch (true) {
          case (error_rate >= DOWN_THRESHOLD):
            status = "down";
            break;
          case (responseTime.p95 >= SLOW_RESPONSE):
            status = "warning";
            break;
          default:
            status = "good"; 
        }

        
  %>
      
  
    <%  if ( i % 4 == 0) { %>
      
      <tr>
    <% } %>
  
      <td class="status-<%- status %>"><span class="glyphicon glyphicon-ok-sign" style="top: 2px;"></span> <a class="app_link" href="/detail/<%- appName %>"><%- appName %></a></td>
    
    <%  if ( i % 4 == 0) { %>
      </tr>
    <% } %>


  <% i++; } %>
  </table>
  

  <script src="/vendor/bootstrap/js/bootstrap.min.js"></script>
</body>
</html>
