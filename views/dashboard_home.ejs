<%

  var last_updated = moment(updated).tz("America/Denver");
  last_updated = last_updated.format('h:mm a');

  var SLOW_RESPONSE = 5000
    , FAST_RESPONSE = 300
    , DOWN_THRESHOLD = 50
    , WARN_MEMORY = 400
    , DATA_KEY = 'status:dashboard:frontier:mem_response'
    , ERROR_KEY = 'status:dashboard:frontier:heroku_errors';


  var API_SLOW_RESPONSE = 1000
    , API_DOWN_THRESHOLD = 50;
  var STATUS_TO_DISPLAY = {
      'good' : 'success',
      'slow' : 'warning',
      'down' : 'danger'
    };
%>

<!DOCTYPE html>
<html>
<head>
  <title>FamilySearch Status</title>
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap.min.css">
  <link rel="stylesheet" href="vendor/bootstrap/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <meta name="viewport" content="width=device-width">
  <meta http-equiv="refresh" content="60">
</head>


<!--
  TODO:
  1) Make the Uptime history as part of the header part...


 -->

<body class="home">
  <nav class="navbar navbar-inverse navbar-static-top" role="navigation">
    <div class="container">
      <div class="navbar-header">
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li class="active"><a href="/">Home</a></li>
          <li><a href="change">Change</a></li>
          <li><a class="refresh" href="#"><span class="glyphicon glyphicon-refresh"></span> Last updated at <span id="updatedTimestamp"><%- last_updated %></span></a></li>
        </ul>
      </div><!--/.nav-collapse -->
    </div>
  </nav>
  <div class="container">

    <div class="mast_head section row">
      <div class="col-md-6 col-xs-12">
        <h1 class="page_title">FamilySearch Status (Alpha) </h1>
      </div>
      <div class="col-md-6 col-xs-12">
        <div class="legend">
          <button class="app_link btn btn-success" title="Error rate < 50% AND Response time < thresholds"><span class="glyphicon glyphicon-ok-sign" style="top: 2px;"></span> Good</button>
          <button class="app_link btn btn-warning" title="Response time > 5s (1s for APIs)"><span class="glyphicon glyphicon-warning-sign" style="top: 2px;"></span> Slow</button>
          <button class="app_link btn btn-danger" title="5xx errors > 50% of total req"><span class="glyphicon glyphicon-minus-sign" style="top: 2px;"></span> Down</button>
          <button class="app_link btn"><span class="glyphicon glyphicon-question-sign" style="top: 2px;"></span> Unknown</button>
        </div>
      </div>
    </div>

    <h2>Frontier</h2>
    <div class="section statuses">
      <%

      for (var i=0, l=appData.length; i < l; i++) {

          var status = appData[i].stats.uptime_status;
          var appName = appData[i].appName;

          //CSS rules for uptime_status
          glyph = "glyphicon-" + ({
            "good" : "ok-sign",
            "slow" : "warning-sign",
            "down" : "minus-sign"
          }[status] || "question-sign");
      %>
        <a class="app_link btn btn-<%- STATUS_TO_DISPLAY[status] %>" href="detail/<%- encodeURIComponent(appName) %>"><span class="glyphicon <%- glyph %>" style="top: 2px;"></span> <%- appName %></a>
      <% } %>
    </div>

    <h2>APIs</h2>
    <div class="section statuses">
      <%
        for(var j=0; j < apiData.length; j++){

          var api_status = apiData[j].stats.uptime_status;

          //CSS classes for uptime_status. FIXME: move this to partial? or fn? We use this everywhere...
          api_glyph = "glyphicon-" + ({
            "good" : "ok-sign",
            "slow" : "warning-sign",
            "down" : "minus-sign"
          }[api_status] || "question-sign")

      %><a class="app_link btn btn-<%- STATUS_TO_DISPLAY[api_status] %>" href="api_detail/<%- encodeURIComponent(apiData[j].api) %>"><span class="glyphicon <%- api_glyph %>" style="top: 2px;"></span> <%- apiData[j].api %></a><% } %>
    </div>

  </div>
  <script src="http://code.jquery.com/jquery-2.0.0.min.js"></script>
  <script src="../vendor/bootstrap/js/bootstrap.min.js"></script>
  <script src="js/utils.js"></script>
</body>
</html>
